#
# -*- coding: utf-8 -*-
# -*- mode:python ; tab-width:4 -*- ex:set tabstop=4 shiftwidth=4 expandtab: -*-
#
# MPX Trackinfo
# (C) 2008 M. Derezynski


import mpx
import mpx_musiclib
import gtkmm
import time
import pygtk
pygtk.require('2.0')
import gtk
import gobject
import gtk.glade
import urllib
import random
import xml
from Ft.Xml.XPath.Context import Context
from Ft.Xml.XPath import Evaluate
from Ft.Xml.Domlette import NonvalidatingReader
from Ft.Xml import EMPTY_NAMESPACE
#import musicbrainz2
#import musicbrainz2.webservice as ws

MBID_NODE_XPATH = u'//mbid'
MATCH_NODE_XPATH = u'//match'

class PlaylistDefaultTooltip(mpx.Plugin):

    def __init__(self,id,player,mcs):

        self.id = id
        f = open("@DATA_DIR@" + "/python-plugins/pltd/pltd.glade")
        self.xmldata = f.read() 
        f.close()
        
        self.lib = player.get_library()
        self.covers = player.get_covers()
        self.mlib = player.get_source("36068e19-dfb3-49cd-85b4-52cea16fe0fd")
        self.mlib.gobj().connect("playlist-tooltip", self.on_playlist_tooltip)

    def on_playlist_tooltip(self, object, treemodel, iter):

        self.xml = gtk.glade.xml_new_from_buffer(self.xmldata, len(self.xmldata))
        self.widget = self.xml.get_widget("widget")
        self.widget.unparent()
        self.image = self.xml.get_widget("image")
        self.labels = []

        for l in ["artist", "album", "title", "bitrate", "samplerate", "type"]:
            self.labels.append(self.xml.get_widget("label-%s" % l))

        mpxtrack_boxed = treemodel.get(iter, 9)[0]
        mpxtrack = mpx.unwrap_boxed_mpxtrack(mpxtrack_boxed)

        if mpxtrack[mpx.AttributeId.ARTIST]:
            self.labels[0].set_text(mpxtrack[mpx.AttributeId.ARTIST].get())

        if mpxtrack[mpx.AttributeId.ALBUM]:
            self.labels[1].set_text(mpxtrack[mpx.AttributeId.ALBUM].get())

        if mpxtrack[mpx.AttributeId.TITLE]:
            self.labels[2].set_text(mpxtrack[mpx.AttributeId.TITLE].get())

        if mpxtrack[mpx.AttributeId.BITRATE]:
            self.labels[3].set_text(str(mpxtrack[mpx.AttributeId.BITRATE].get())+ " kbit/s")

        if mpxtrack[mpx.AttributeId.SAMPLERATE]:
            self.labels[4].set_text(str(mpxtrack[mpx.AttributeId.SAMPLERATE].get()/1000.)+ " KHz")

        if mpxtrack[mpx.AttributeId.TYPE]:
            self.labels[5].set_text(mpxtrack[mpx.AttributeId.TYPE].get())

        self.image.hide()
        if mpxtrack[mpx.AttributeId.MB_ALBUM_ID]:
            mbid = mpxtrack[mpx.AttributeId.MB_ALBUM_ID].get()
            cover = self.covers.fetch(mbid) 
            if cover:
                self.image.set_from_pixbuf(cover.scale_simple(112, 112, gtk.gdk.INTERP_BILINEAR))
                self.image.show()

        return self.widget
